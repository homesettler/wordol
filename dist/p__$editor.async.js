(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[1],{mubv:function(e,s,t){"use strict";t.r(s);var i=t("q1tI"),o=t.n(i);class n{static createSocket(e,s,t,i){var o;if("WebSocket"in window){var n="ws://192.168.1.139:8080/word/"+e+"/"+s;o=new WebSocket(n),o.onerror=(()=>{console.log("error")}),o.onopen=(()=>{console.log("open")}),o.onmessage=(e=>{t(e)}),o.onclose=(()=>{console.log("close")})}else alert("\u6d4f\u89c8\u5668\u4e0d\u652f\u6301WebSocket");return o}}var r=n,a=t("kzlf"),h=t.n(a);t("gJae");class p{static ops2Message(e){var s={operation:"",position:0,message:"",fileId:"",userId:"",state:0};return e.forEach(e=>{e.hasOwnProperty("retain")?s["position"]=e["retain"]:e.hasOwnProperty("insert")?(s["operation"]="insert",s["message"]=e["insert"]):e.hasOwnProperty("delete")&&(s["operation"]="delete",s["message"]=e["delete"].toString())}),s}static message2Ops(e){var s=[];return"noop"===e["operation"]?null:(0!==e["position"]&&s.push({retain:e["position"]}),"insert"===e["operation"]&&s.push({insert:e["message"]}),"delete"===e["operation"]&&s.push({delete:parseInt(e["message"])}),s)}static opsToOpsList(e){var s=0,t=[];return e.forEach(e=>{if(e.hasOwnProperty("retain")&&(s=e["retain"]),e.hasOwnProperty("insert")){var i=[];i.push({retain:s}),i.push(e),s+=e["insert"].length,t.push(i)}else if(e.hasOwnProperty("delete")){var o=[];o.push({retain:s}),o.push(e),t.push(o)}}),t}}var l=p;class d{constructor(e,s,t){this.outgoing={},this.userId=s,this.fileId=t,this.myMsgs=0,this.otherMsgs=0,this.webSocket=e,this.receiveBuffer=[],this.xform=this.xform.bind(this),this.generate=this.generate.bind(this),this.receive=this.receive.bind(this),this.receiveToBuffer=this.receiveToBuffer.bind(this),this.applyBuffer=this.applyBuffer.bind(this)}generate(e){if(0!==e.length)if(3!==e.length){var s=l.ops2Message(e);console.log(s),s["fileId"]=this.fileId,s["userId"]=this.userId,s["state"]=this.otherMsgs,this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify(s)),s["state"]=this.myMsgs,this.outgoing[this.myMsgs]=s,this.myMsgs=this.myMsgs+1}else{var t=l.opsToOpsList(e);t.forEach(e=>{this.generate(e)})}}receiveToBuffer(e){this.receiveBuffer.push(e)}applyBuffer(){var e=[];return this.receiveBuffer.forEach(s=>{e.push(this.receive(s))}),this.receiveBuffer=[],e}receive(e){Object.keys(this.outgoing).forEach(s=>{this.outgoing[s]["state"]<e["state"]&&delete this.outgoing[s]});var s=e;Object.keys(this.outgoing).forEach(e=>{s=this.xform(s,this.outgoing[e])});var t=l.message2Ops(e);return this.otherMsgs=this.otherMsgs+1,t}xform(e,s){if("delete"===e["operation"]&&"delete"===s["operation"])if(e["position"]>s["position"])e["position"]=e["position"]-parseInt(s["message"]);else{if(!(e["position"]<s["position"]))return e["operation"]="noop",s["operation"]="noop",1;s["position"]=s["position"]-parseInt(e["message"])}else"delete"===e["operation"]&&"insert"===s["operation"]?e["position"]>=s["position"]?e["position"]=e["position"]+s["message"].length:s["position"]=s["position"]-parseInt(e["message"]):"insert"===e["operation"]&&"delete"===s["operation"]?e["position"]>s["position"]?e["position"]=e["position"]-parseInt(s["message"]):s["position"]=s["position"]+e["message"].length:"insert"===e["operation"]&&"insert"===s["operation"]?e["position"]>s["position"]?e["position"]=e["position"]+s["message"].length:e["position"]<s["position"]?s["position"]=s["position"]+e["message"].length:e["position"]=e["position"]+s["message"].length:console.log("unknow operation");return e}}var g=d;class c extends o.a.Component{constructor(e){super(e),this.isComposition="end",this.editor=null,this.selection=null,this.compositionBuffer=[],this.handleTextChange=this.handleTextChange.bind(this),this.handleMessage=this.handleMessage.bind(this),this.handleSelectionChange=this.handleSelectionChange.bind(this),this.state={webSocket:r.createSocket(this.props.userId,this.props.fileId,this.handleMessage)},this.messageHandler=new g(this.state.webSocket,this.props.userId,this.props.fileId),this.handleComposition=this.handleComposition.bind(this),this.handleCompositionBuffer=this.handleCompositionBuffer.bind(this)}componentDidMount(){var e={debug:"warn",theme:"snow"};null==this.editor&&(this.editor=new h.a("#editor",e)),this.nullDelta=this.editor.getContents(),this.editor.on("text-change",this.handleTextChange),this.editor.on("selection-change",this.handleSelectionChange)}handleSelectionChange(e,s,t){this.selection=e,console.log(e)}handleTextChange(e,s,t){if("user"===t)if("end"===this.isComposition)this.messageHandler.generate(e["ops"]);else{var i=e["ops"];"start"===this.isComposition?(this.isComposition="composing",this.compositionBuffer.push(i)):this.compositionBuffer.push(i)}}handleMessage(e){var s=JSON.parse(e.data);if(console.log(s),s["userId"]!==this.props.userId)if("end"===this.isComposition){var t=this.messageHandler.receive(s);null!==t&&this.editor.updateContents(t)}else this.messageHandler.receiveToBuffer(s)}handleCompositionBuffer(){var e=this.editor.getContents();return e["ops"]=[],this.compositionBuffer.forEach(s=>{e=e.compose({ops:s})}),this.compositionBuffer=[],console.log(e["ops"]),e["ops"]}handleComposition(e){if("compositionstart"===e.type)this.isComposition="start",console.log("start");else if("compositionupdate"===e.type)console.log(e.data);else{console.log("end"),this.messageHandler.generate(this.handleCompositionBuffer()),this.editor.disable();var s=this.messageHandler.applyBuffer();s.forEach(e=>{this.editor.updateContents(e)}),this.editor.enable(),this.editor.focus(),this.isComposition="end"}}render(){return o.a.createElement("div",{id:"editor",onCompositionStart:this.handleComposition,onCompositionEnd:this.handleComposition,onCompositionUpdate:this.handleComposition})}}var u=c;class f extends o.a.Component{render(){var e=this.props.location["pathname"],s=e.toString().split("/");return o.a.createElement(u,{userId:s[2],fileId:s[3]})}}s["default"]=f}}]);